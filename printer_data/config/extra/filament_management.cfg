#####################################################################
# Filament Management System
# Supports: PLA, ASA, ABS, TPU, NYLON, CF (carbon/glass filled)
# Features:
#   - KlipperScreen prompts for filament selection
#   - Persistent storage of loaded filament type
#   - Automatic temperature management
#   - Purge cycles when changing filament types
#   - Higher temp maintained when switching from hot to cold filaments
#####################################################################

# Required: Add this to your printer.cfg if not already present
# [save_variables]
# filename: ~/printer_data/config/saved_variables.cfg

#####################################################################
# Filament Configuration
#####################################################################

[gcode_macro _FILAMENT_VARS]
description: Filament temperature and settings configuration
# Temperatures: [load_temp, unload_temp, purge_temp]
# purge_temp is used when switching FROM this filament to a cooler one
variable_filament_temps: {
    'PLA':   {'load': 210, 'unload': 210, 'purge': 220},
    'ASA':   {'load': 250, 'unload': 245, 'purge': 255},
    'ABS':   {'load': 250, 'unload': 245, 'purge': 255},
    'TPU':   {'load': 230, 'unload': 225, 'purge': 235},
    'NYLON': {'load': 260, 'unload': 255, 'purge': 265},
    'CF':    {'load': 270, 'unload': 265, 'purge': 275}
    }
# Extrusion distances for Orbiter 2.0 direct drive
variable_load_distance: 50        # Distance to load filament to nozzle
variable_purge_distance: 50       # Purge amount when changing types
variable_unload_distance: 60      # Distance to fully retract
variable_load_speed: 300          # mm/min for loading
variable_purge_speed: 150         # mm/min for purging (slower)
variable_unload_speed: 300        # mm/min for unloading
variable_fast_unload_speed: 1200  # mm/min for initial fast retract
gcode:
    # Configuration macro - no direct gcode

#####################################################################
# Persistent Storage Helpers
#####################################################################

[gcode_macro _GET_LOADED_FILAMENT]
description: Returns currently loaded filament type from saved variables
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set loaded = svv.loaded_filament|default('NONE') %}
    {action_respond_info("Currently loaded filament: %s" % loaded)}

[gcode_macro _SET_LOADED_FILAMENT]
description: Saves the currently loaded filament type
gcode:
    {% set TYPE = params.TYPE|default('NONE')|upper %}
    SAVE_VARIABLE VARIABLE=loaded_filament VALUE="'{TYPE}'"
    {action_respond_info("Filament type set to: %s" % TYPE)}

#####################################################################
# Main User Macros
#####################################################################

[gcode_macro LOAD_FILAMENT]
description: Load filament with KlipperScreen prompt for type selection
gcode:
    {% if printer.print_stats.state == "printing" %}
        {action_respond_info("Cannot load filament while printing!")}
    {% else %}
        # Show filament selection prompt
        RESPOND TYPE=command MSG="action:prompt_begin Load Filament"
        RESPOND TYPE=command MSG="action:prompt_text Select filament type to load:"
        RESPOND TYPE=command MSG="action:prompt_button PLA|_LOAD_FILAMENT_TYPE TYPE=PLA"
        RESPOND TYPE=command MSG="action:prompt_button ASA|_LOAD_FILAMENT_TYPE TYPE=ASA"
        RESPOND TYPE=command MSG="action:prompt_button ABS|_LOAD_FILAMENT_TYPE TYPE=ABS"
        RESPOND TYPE=command MSG="action:prompt_button TPU|_LOAD_FILAMENT_TYPE TYPE=TPU"
        RESPOND TYPE=command MSG="action:prompt_button NYLON|_LOAD_FILAMENT_TYPE TYPE=NYLON"
        RESPOND TYPE=command MSG="action:prompt_button CF/GF|_LOAD_FILAMENT_TYPE TYPE=CF"
        RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=action:prompt_end"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
description: Unload filament - uses stored type or prompts if unknown
gcode:
    {% if printer.print_stats.state == "printing" %}
        {action_respond_info("Cannot unload filament while printing!")}
    {% else %}
        {% set svv = printer.save_variables.variables %}
        {% set loaded = svv.loaded_filament|default('NONE') %}
        
        {% if loaded != 'NONE' %}
            # We know what's loaded, unload it directly
            _UNLOAD_FILAMENT_TYPE TYPE={loaded}
        {% else %}
            # Unknown filament, prompt for type
            RESPOND TYPE=command MSG="action:prompt_begin Unload Filament"
            RESPOND TYPE=command MSG="action:prompt_text Select current filament type:"
            RESPOND TYPE=command MSG="action:prompt_button PLA|_UNLOAD_FILAMENT_TYPE TYPE=PLA"
            RESPOND TYPE=command MSG="action:prompt_button ASA|_UNLOAD_FILAMENT_TYPE TYPE=ASA"
            RESPOND TYPE=command MSG="action:prompt_button ABS|_UNLOAD_FILAMENT_TYPE TYPE=ABS"
            RESPOND TYPE=command MSG="action:prompt_button TPU|_UNLOAD_FILAMENT_TYPE TYPE=TPU"
            RESPOND TYPE=command MSG="action:prompt_button NYLON|_UNLOAD_FILAMENT_TYPE TYPE=NYLON"
            RESPOND TYPE=command MSG="action:prompt_button CF/GF|_UNLOAD_FILAMENT_TYPE TYPE=CF"
            RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=action:prompt_end"
            RESPOND TYPE=command MSG="action:prompt_show"
        {% endif %}
    {% endif %}

[gcode_macro CHANGE_FILAMENT]
description: Full filament change - unload current, purge, load new
gcode:
    {% if printer.print_stats.state == "printing" %}
        {action_respond_info("Cannot change filament while printing!")}
    {% else %}
        # Prompt for new filament type - will handle unload automatically
        RESPOND TYPE=command MSG="action:prompt_begin Change Filament"
        RESPOND TYPE=command MSG="action:prompt_text Select NEW filament type to load:"
        RESPOND TYPE=command MSG="action:prompt_button PLA|_CHANGE_FILAMENT_TO TYPE=PLA"
        RESPOND TYPE=command MSG="action:prompt_button ASA|_CHANGE_FILAMENT_TO TYPE=ASA"
        RESPOND TYPE=command MSG="action:prompt_button ABS|_CHANGE_FILAMENT_TO TYPE=ABS"
        RESPOND TYPE=command MSG="action:prompt_button TPU|_CHANGE_FILAMENT_TO TYPE=TPU"
        RESPOND TYPE=command MSG="action:prompt_button NYLON|_CHANGE_FILAMENT_TO TYPE=NYLON"
        RESPOND TYPE=command MSG="action:prompt_button CF/GF|_CHANGE_FILAMENT_TO TYPE=CF"
        RESPOND TYPE=command MSG="action:prompt_footer_button Cancel|RESPOND TYPE=command MSG=action:prompt_end"
        RESPOND TYPE=command MSG="action:prompt_show"
    {% endif %}

#####################################################################
# Force/Override Macros
#####################################################################

[gcode_macro SET_FILAMENT_TYPE]
description: Force set the current filament type without loading
gcode:
    {% set TYPE = params.TYPE|default('NONE')|upper %}
    {% set vars = printer["gcode_macro _FILAMENT_VARS"] %}
    {% set valid_types = vars.filament_temps.keys()|list %}
    
    {% if TYPE in valid_types or TYPE == 'NONE' %}
        _SET_LOADED_FILAMENT TYPE={TYPE}
        M117 Filament: {TYPE}
    {% else %}
        {action_respond_info("Invalid filament type: %s. Valid types: %s" % (TYPE, valid_types|join(', ')))}
    {% endif %}

[gcode_macro FORCE_LOAD]
description: Force load specific filament type (skips prompt)
gcode:
    {% set TYPE = params.TYPE|default('ASA')|upper %}
    _LOAD_FILAMENT_TYPE TYPE={TYPE}

[gcode_macro FORCE_UNLOAD]
description: Force unload specific filament type (skips prompt)
gcode:
    {% set TYPE = params.TYPE|default('ASA')|upper %}
    _UNLOAD_FILAMENT_TYPE TYPE={TYPE}

[gcode_macro SHOW_FILAMENT]
description: Display currently loaded filament type
gcode:
    {% set svv = printer.save_variables.variables %}
    {% set loaded = svv.loaded_filament|default('NONE') %}
    M117 Loaded: {loaded}
    {action_respond_info("Currently loaded filament: %s" % loaded)}

#####################################################################
# Internal Implementation Macros
#####################################################################

[gcode_macro _LOAD_FILAMENT_TYPE]
description: Internal - Load filament of specified type
gcode:
    {% set TYPE = params.TYPE|upper %}
    {% set vars = printer["gcode_macro _FILAMENT_VARS"] %}
    {% set temps = vars.filament_temps[TYPE] %}
    {% set svv = printer.save_variables.variables %}
    {% set old_filament = svv.loaded_filament|default('NONE') %}
    
    # Close prompt
    RESPOND TYPE=command MSG="action:prompt_end"
    
    # Determine if we need to purge (changing from different filament)
    {% set need_purge = (old_filament != 'NONE' and old_filament != TYPE) %}
    
    # If switching from hotter filament, use higher temp for purge
    {% if need_purge %}
        {% set old_temps = vars.filament_temps[old_filament] %}
        {% set purge_temp = [old_temps.purge, temps.load]|max %}
    {% else %}
        {% set purge_temp = temps.load %}
    {% endif %}
    
    STATUS_HEATING
    M117 Heating for {TYPE}...
    {action_respond_info("Heating to %d°C for %s" % (temps.load if not need_purge else purge_temp, TYPE))}
    
    # Heat to appropriate temperature
    {% if need_purge %}
        M109 S{purge_temp}
    {% else %}
        M109 S{temps.load}
    {% endif %}
    
    STATUS_BUSY
    M117 Loading {TYPE}...
    M83                                          # Relative extrusion
    G92 E0                                       # Reset extruder
    
    # Slow load to engage gears
    G1 E10 F{vars.load_speed / 2}
    # Fast load to nozzle
    G1 E{vars.load_distance} F{vars.load_speed}
    
    # Purge cycle if changing filament types
    {% if need_purge %}
        M117 Purging {old_filament}...
        {action_respond_info("Purging old %s filament..." % old_filament)}
        G1 E{vars.purge_distance} F{vars.purge_speed}
        G1 E{vars.purge_distance} F{vars.purge_speed}
        
        # If new filament needs lower temp, cool down and do final purge
        {% if temps.load < purge_temp %}
            M117 Cooling to {temps.load}...
            M109 S{temps.load}
            G1 E{vars.purge_distance / 2} F{vars.purge_speed}
        {% endif %}
    {% else %}
        # Standard purge for fresh load
        G1 E{vars.purge_distance / 2} F{vars.purge_speed}
    {% endif %}
    
    G92 E0                                       # Reset extruder
    M82                                          # Absolute extrusion
    
    # Save filament type
    _SET_LOADED_FILAMENT TYPE={TYPE}
    
    # Cool down if not printing
    {% if printer.print_stats.state != "paused" %}
        M104 S0
    {% endif %}
    
    STATUS_READY
    M117 {TYPE} loaded!
    {action_respond_info("%s filament loaded successfully" % TYPE)}

[gcode_macro _UNLOAD_FILAMENT_TYPE]
description: Internal - Unload filament of specified type
gcode:
    {% set TYPE = params.TYPE|upper %}
    {% set vars = printer["gcode_macro _FILAMENT_VARS"] %}
    {% set temps = vars.filament_temps[TYPE] %}
    
    # Close prompt
    RESPOND TYPE=command MSG="action:prompt_end"
    
    STATUS_HEATING
    M117 Heating for unload...
    {action_respond_info("Heating to %d°C for %s unload" % (temps.unload, TYPE))}
    M109 S{temps.unload}
    
    STATUS_BUSY
    M117 Unloading {TYPE}...
    M83                                          # Relative extrusion
    G92 E0                                       # Reset extruder
    
    # Small extrusion to release pressure
    G1 E5 F{vars.purge_speed}
    G4 P1000                                     # Wait 1 second
    
    # Tip shaping sequence for clean break
    G1 E-5 F{vars.fast_unload_speed}             # Fast retract
    G4 P500                                      # Pause
    G1 E4 F{vars.load_speed}                     # Push back
    G1 E-5 F{vars.fast_unload_speed}             # Fast retract again
    
    # Full retraction - slow to prevent grinding
    G1 E-{vars.unload_distance} F{vars.unload_speed}
    
    G92 E0                                       # Reset extruder
    M82                                          # Absolute extrusion
    
    # Clear filament type
    _SET_LOADED_FILAMENT TYPE=NONE
    
    # Cool down if not printing
    {% if printer.print_stats.state != "paused" %}
        M104 S0
    {% endif %}
    
    STATUS_READY
    M117 Filament unloaded!
    {action_respond_info("%s filament unloaded successfully" % TYPE)}

[gcode_macro _CHANGE_FILAMENT_TO]
description: Internal - Full filament change sequence
gcode:
    {% set NEW_TYPE = params.TYPE|upper %}
    {% set vars = printer["gcode_macro _FILAMENT_VARS"] %}
    {% set svv = printer.save_variables.variables %}
    {% set old_filament = svv.loaded_filament|default('NONE') %}
    {% set new_temps = vars.filament_temps[NEW_TYPE] %}
    
    # Close prompt
    RESPOND TYPE=command MSG="action:prompt_end"
    
    # Determine temperatures
    {% if old_filament != 'NONE' %}
        {% set old_temps = vars.filament_temps[old_filament] %}
        {% set unload_temp = old_temps.unload %}
        {% set purge_temp = [old_temps.purge, new_temps.load]|max %}
    {% else %}
        {% set unload_temp = new_temps.load %}
        {% set purge_temp = new_temps.load %}
    {% endif %}
    
    {action_respond_info("Changing from %s to %s" % (old_filament, NEW_TYPE))}
    
    # Unload current filament if present
    {% if old_filament != 'NONE' %}
        STATUS_HEATING
        M117 Heating to unload {old_filament}...
        M109 S{unload_temp}
        
        STATUS_BUSY
        M117 Unloading {old_filament}...
        M83
        G92 E0
        
        # Tip shaping
        G1 E5 F{vars.purge_speed}
        G4 P1000
        G1 E-5 F{vars.fast_unload_speed}
        G4 P500
        G1 E4 F{vars.load_speed}
        G1 E-5 F{vars.fast_unload_speed}
        G1 E-{vars.unload_distance} F{vars.unload_speed}
        G92 E0
    {% endif %}
    
    # Wait for new filament insertion
    M117 Insert {NEW_TYPE}, wait...
    {action_respond_info("Insert %s filament and wait 5 seconds..." % NEW_TYPE)}
    G4 P5000                                     # 5 second pause
    
    # Heat to purge temperature if needed
    {% if purge_temp != printer.extruder.target %}
        STATUS_HEATING
        M117 Heating for {NEW_TYPE}...
        M109 S{purge_temp}
    {% endif %}
    
    # Load new filament
    STATUS_BUSY
    M117 Loading {NEW_TYPE}...
    M83
    G92 E0
    
    G1 E10 F{vars.load_speed / 2}                # Slow engage
    G1 E{vars.load_distance} F{vars.load_speed}  # Load to nozzle
    
    # Extended purge to clear old filament
    {% if old_filament != 'NONE' and old_filament != NEW_TYPE %}
        M117 Purging {old_filament}...
        G1 E{vars.purge_distance} F{vars.purge_speed}
        G1 E{vars.purge_distance} F{vars.purge_speed}
        G1 E{vars.purge_distance} F{vars.purge_speed}
        
        # Cool to new filament temp if needed
        {% if new_temps.load < purge_temp %}
            M117 Cooling to {new_temps.load}...
            M109 S{new_temps.load}
            G1 E{vars.purge_distance / 2} F{vars.purge_speed}
        {% endif %}
    {% else %}
        G1 E{vars.purge_distance / 2} F{vars.purge_speed}
    {% endif %}
    
    G92 E0
    M82
    
    # Save new filament type
    _SET_LOADED_FILAMENT TYPE={NEW_TYPE}
    
    # Cool down if not printing
    {% if printer.print_stats.state != "paused" %}
        M104 S0
    {% endif %}
    
    STATUS_READY
    M117 {NEW_TYPE} ready!
    {action_respond_info("Filament changed to %s successfully" % NEW_TYPE)}

